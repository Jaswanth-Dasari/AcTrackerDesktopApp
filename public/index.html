 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Activity Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="nav-toggle" onclick="toggleSidebar()">
                <i class="fas fa-chevron-left"></i>
            </div>
            
            <div class="logo">
                <h2>AcTracker</h2>
            </div>
            
            <nav>
                <a href="#" class="nav-item" data-tooltip="Dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-tooltip="Activity">
                    <i class="fas fa-clock"></i>
                    <span>Activity</span>
                </a>
                <a href="#" class="nav-item" data-tooltip="Screenshots">
                    <i class="fas fa-camera"></i>
                    <span>Screenshots</span>
                </a>
                <a href="#" class="nav-item" data-tooltip="Settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
        </div>

        <div class="dashboard-content">
            <header class="dashboard-header">
                <h1>User Activity Dashboard</h1>
                <div id="week-range"></div>
                <div class="action-buttons">
                    <button onclick="showModal('create-project-modal')">Create a Project</button>
                    <button onclick="showModal('track-time-modal')">Track Time</button>
                    <button onclick="showModal('invite-team-modal')">Invite Your Team</button>
                    <button onclick="showModal('settings-modal')">Settings</button>
                </div>
            </header>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>Worked This Week</h3>
                    <p id="worked-time">Loading...</p>
                </div>
                <div class="card">
                    <h3>Last Worked</h3>
                    <p id="last-worked-time">Loading...</p>
                </div>
                <div class="card">
                    <h3 > Total Projects Worked</h3>
                    <p id="projects-worked" >Loading...</p>
                </div>
            </div>

            <div class="flex-container">
                <div class="screenshot-container" id="screenshot-container">
                    <h3>Recent Screenshots</h3>
                    <button id="capture-screenshot-btn">Capture Screenshot</button>
                    <div id="status"></div>
                    <div class="screenshots" id="recent-screenshots">
                    </div>
                </div>
                

                <div class="graph-container">
                    <h3>Activity Graph</h3>
                    <canvas id="activity-chart"></canvas>
                </div>

                <div class="graph-container">
                    <h3>Browser Activity</h3>
                    <div id="browser-activity-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Application</th>
                                    <th>Time Spent (%)</th>
                                </tr>
                            </thead>
                            <tbody id="browser-activity-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Structure -->
    <div class="modal" id="create-project-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('create-project-modal')">&times;</span>
            <h2>Create a Project</h2>

            <!-- Tab Navigation -->
            <div class="tab-container">
                <button class="tab-link active" onclick="openTab(event, 'general')">General</button>
                <button class="tab-link" onclick="openTab(event, 'members')">Members</button>
                <button class="tab-link" onclick="openTab(event, 'budget-limits')">Budget & Limits</button>
                <button class="tab-link" onclick="openTab(event, 'teams')">Teams</button>
            </div>

            <!-- Tab Content -->
            <div id="general" class="tab-content active">
                <input type="text" placeholder="Project Name" id="project-name" required>
                <input type="text" placeholder="Client Name" id="client-name" required>
                <label>Billable?</label>
                <input type="checkbox" id="billable">
                <div class="modal-footer">
                    <button onclick="openTab(event, 'members')">Next</button>
                    <button onclick="closeModal('create-project-modal')">Cancel</button>
                </div>
            </div>

            <div id="members" class="tab-content ">
                <input type="search" placeholder="Enter Managers" id="managers">
                <input type="search" placeholder="Enter Users" id="users">
                <input type="search" placeholder="Enter Viewers" id="viewers">
                <div class="modal-footer">
                    <button onclick="openTab(event, 'budget-limits')">Next</button>
                    <button onclick="closeModal('create-project-modal')">Cancel</button>
                </div>
            </div>

            <div id="budget-limits" class="tab-content ">
                <label>Type</label>
                <select id="budget-type">
                    <option>Total Cost</option>
                    <option>Total Hours</option>
                </select>

                <label>Based On</label>
                <select id="based-on">
                    <option>Bill Rate</option>
                    <option>Pay Rate</option>
                </select>

                <input type="number" placeholder="Cost" id="budget-cost">
                <div class="modal-footer">
                    <button onclick="openTab(event, 'teams')">Next</button>
                    <button onclick="closeModal('create-project-modal')">Cancel</button>
                </div>
            </div>

            <div id="teams" class="tab-content">
                <input type="search" placeholder="Enter Teams" id="teams-search">
                <div class="modal-footer">
                    <button onclick="saveDetails()">Save</button>
                    <button onclick="closeModal('create-project-modal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Track Time Modal -->
    <div class="modal" id="track-time-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('track-time-modal')">&times;</span>
            <h2>Track Time</h2>

            <!-- Tab Navigation -->
            <div class="tab-container">
                <button class="tab-link active" onclick="openTab(event, 'web-timer')">Web Timer</button>
            </div>

            <!-- Tab Content -->
            <div id="web-timer" class="tab-content active">
                <p>Using the web timer in your browser allows you and your team to track time to projects and to-dos. The web timer does not record activity, screenshots, apps, or URLs.</p>
                <button onclick="showModal('web-timer-modal')">Open Web Timer</button>
            </div>
        </div>
    </div>

    <!-- Web Timer Modal (Initial state) -->
<div class="modal" id="web-timer-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('web-timer-modal')">&times;</span>
        <h2>Web Timer</h2>

        <div class="timer-container">
            <div class="timer" id="timer-display"></div>
            <button id="play-pause-btn" class="play-pause-btn" onclick="toggleTimer()"></button>
        </div>

        <label for="project-select">Select Project:</label>
        <select id="project-select">
            <option value="" disabled selected>Select a project</option>
        </select>
        <div class="modal-footer">
            <button id="start-timer-btn" onclick="startTimer(); closeModal('track-time-modal'); closeModal('web-timer-modal');">
                Start
            </button>
            <button onclick="closeModal('web-timer-modal')">Cancel</button>
        </div>
        
    </div>
</div>
<!-- Floating Timer Window (Draggable) -->
<div class="floating-timer" id="floating-timer">
    <div class="floating-timer-header" id="floating-timer-header">Drag Timer</div>
    <div class="timer-display" id="floating-timer-display">00:00:00</div>
    <button id="floating-stop-btn"  onclick="stopTimer();" >Stop</button>
</div>
<!-- Web Timer Modal Start Button -->

    <div class="modal" id="invite-team-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('invite-team-modal')">&times;</span>
        <h2>Invite Your Team</h2>
        <input type="email" id="email-input" placeholder="Team Member Email" required>
        <button id="send-invite-button" onclick="closeModal('invite-team-modal')">Send Invitation</button>
    </div>
</div>


    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('settings-modal')">&times;</span>
            <h2>Settings</h2>
            <input type="text" placeholder="Setting Name" required>
            <button>Save</button>
        </div>
    </div>

    <!-- <script src="app.js"></script> -->
    <script>

        // Function to show modal
        function showModal(modalId) {re
            document.getElementById(modalId).style.display = 'block';
        }

        // Function to close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // resetTimer(); // Reset timer when closing the web timer modal
        }

        // Function to switch between tabs
        function openTab(event, tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');

            // Remove active class from all tab buttons
            const tabLinks = document.querySelectorAll('.tab-link');
            tabLinks.forEach(link => link.classList.remove('active'));

            // Set clicked tab button as active
            event.currentTarget.classList.add('active');
        }

       

        function saveDetails() {
            const projectName = document.getElementById('project-name').value;
            const clientName = document.getElementById('client-name').value;
            const isBillable = document.getElementById('billable').checked;
            const managers = document.getElementById('managers').value;
            const users = document.getElementById('users').value;
            const viewers = document.getElementById('viewers').value;
            const budgetType = document.getElementById('budget-type').value;
            const basedOn = document.getElementById('based-on').value;
            const cost = document.getElementById('budget-cost').value;
            const teamsSearch = document.getElementById('teams-search').value;


            fetch('https://actracker.onrender.com/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ projectName, clientName, isBillable, managers, users, viewers,budgetType, basedOn, cost ,teamsSearch }),
            })
            .then(response => response.json())
            .then(data => {
                alert('Details saved successfully!');
                closeModal('create-project-modal');
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // // Example: Date and Time display
        // setInterval(() => {
        //     document.getElementById('date-time').innerText = new Date().toLocaleString();
        // }, 1000);

        // Example: Chart.js for activity graph
        // const ctx = document.getElementById('activity-chart').getContext('2d');
        
    
// });

function fetchProjectCount() {
    fetch('https://actracker.onrender.com/projects/count')
        .then(response => response.json())
        .then(data => {
            document.getElementById('projects-worked').innerText = data.count;
        })
        .catch(error => {
            console.error('Error fetching project count:', error);
        });
}
fetchProjectCount();

    </script>
    <script>


// Function to filter projects based on input
function filterProjects() {
    const input = document.getElementById('project-search').value.toLowerCase();
    const projectList = document.getElementById('project-list');
    projectList.innerHTML = ''; // Clear previous list
    if (input.length === 0) {
        projectList.style.display = 'none'; // Hide list if input is empty
        return;
    }

    const filteredProjects = projects.filter(project => project.name.toLowerCase().includes(input));
    if (filteredProjects.length > 0) {
        filteredProjects.forEach(project => {
            const div = document.createElement('div');
            div.textContent = project.name; // Display project name
            div.onclick = () => selectProject(project); // Set click handler to select project
            projectList.appendChild(div);
        });
        projectList.style.display = 'block'; // Show filtered project list
    } else {
        projectList.style.display = 'none'; // Hide if no matches
    }
}

// Function to select a project from the list
function selectProject(project) {
    document.getElementById('project-search').value = project.name; // Set input value
    document.getElementById('project-list').style.display = 'none'; // Hide project list
}

// Timer functions
function toggleTimer() {
    if (isTimerRunning) {
        pauseTimer();
    } else {
        startTimer();
    }
}

        let projects = [];

        // Fetch projects from the server and populate the dropdown
        function fetchProjects() {
            fetch('https://actracker.onrender.com/projects')
                .then(response => response.json())
                .then(data => {
                    projects = data; // Store projects
                    const projectSelect = document.getElementById('project-select');
                    projectSelect.innerHTML = '<option value="" disabled selected>Select a project</option>'; // Clear existing options

                    // Populate dropdown with project names
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project._id; // Use project ID as the value
                        option.textContent = project.projectName; // Display project name
                        projectSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching projects:', error);
                });
        }

        // Show modal and fetch projects when opening the web-timer modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'web-timer-modal') {
                fetchProjects(); // Fetch projects when opening the web-timer modal
            }
        }

// Update the event listener for the "Start" button
document.getElementById('start-timer-btn').addEventListener('click', () => {
    startTimer();
});

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    fetchRecentScreenshots();  // Fetch recent screenshots on page load

    // Add event listener to capture screenshot button
    document.getElementById('capture-screenshot-btn').addEventListener('click', captureScreenshot);
});

// Timer functions
let isTimerRunning = false;
let timerInterval;
let screenshotInterval; // New variable for the screenshot interval
let secondsElapsed = 0;

function startTimer() {
    // Check if a project is selected
    const projectSelect = document.getElementById('project-select');
    const projectId = projectSelect.value;
    if (!projectId) {
        alert('Please select a project before starting the timer.');
        return;
    }

    // Close the modals (Track Time and Web Timer)
    closeModal('track-time-modal');
    closeModal('web-timer-modal');

    // Display the floating timer
    document.getElementById('floating-timer').style.display = 'block';

    // Prevent multiple intervals from being created
    if (isTimerRunning) {
        clearInterval(timerInterval);
        clearInterval(screenshotInterval);
    }

    // Reset the timer state
    secondsElapsed = 0;
    document.getElementById('floating-timer-display').innerText = formatTime(secondsElapsed);

    // Start counting seconds for the timer
    isTimerRunning = true;
    timerInterval = setInterval(() => {
        secondsElapsed++;
        document.getElementById('floating-timer-display').innerText = formatTime(secondsElapsed);
    }, 1000); // Update every 1000ms (1 second) to ensure accurate timing

    // Capture screenshot every 10 seconds
    screenshotInterval = setInterval(() => {
        captureScreenshot();
    }, 10000); // 10000ms = 10 seconds
}


function stopTimer() {
    if (isTimerRunning) {
        clearInterval(timerInterval);  // Stop the timer
        clearInterval(screenshotInterval);  // Stop capturing screenshots
        isTimerRunning = false;

        const formattedTime = formatTime(secondsElapsed);
        console.log('Timer Stopped. Time spent: ' + formattedTime);

        // Send the worked time and project info to the backend
        const projectSelect = document.getElementById('project-select');
        const projectId = projectSelect.value;
        const workedTime = secondsElapsed;  // Time in seconds

        fetch('https://actracker.onrender.com/api/save-time-entry', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: 'user123',  // Replace with actual user ID
                projectId: projectId,
                workedTime: workedTime
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Time entry saved successfully:', data);
        })
        .catch(error => {
            console.error('Error saving time entry:', error);
        });

        // Reset timer UI
        document.getElementById('floating-timer').style.display = 'none';
        secondsElapsed = 0;
        stopActivityTracking();
    }
}
// Call stopTimer when the page unloads (user refreshes or navigates away)
// window.addEventListener('beforeunload', (event) => {
//     stopTimer();
//     stopContinuousScreenshot(); // Stop continuous screenshot capturing
//     // Optionally trigger confirmation dialog on most browsers
//     event.returnValue = ''; // Display a confirmation dialog on certain browsers
// });    


function pauseTimer() {
    isTimerRunning = false;
    document.getElementById('play-pause-btn').innerHTML = '▶️';
    clearInterval(timerInterval);
    clearInterval(screenshotInterval);  // Pause screenshot capturing
}

function resetTimer() {
    secondsElapsed = 0;
    document.getElementById('timer-display').innerText = '00:00:00';
    pauseTimer();
    document.getElementById('start-timer-btn').disabled = false; // Re-enable start button
}

function formatTime(seconds) {
    const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    return `${hours}:${minutes}:${secs}`;
}




// // Function to fetch recent screenshots (assumed to be defined elsewhere)
// function fetchRecentScreenshots() {
//     fetch('https://actracker.onrender.com/api/recent-screenshots')
//         .then(response => response.json())
//         .then(screenshots => {
//             const screenshotsContainer = document.getElementById('recent-screenshots');
//             screenshotsContainer.innerHTML = '';  // Clear existing screenshots

//             screenshots.forEach(screenshot => {
//                 const img = document.createElement('img');
//                 img.src = screenshot.imagePath;  // Set the image source to the screenshot path
//                 img.alt = `Screenshot taken at ${new Date(screenshot.timestamp).toLocaleString()}`;
//                 img.width = 200;  // Set desired width
//                 img.height = 150;  // Set desired height

//                 screenshotsContainer.appendChild(img);  // Add the image to the container
//             });
//         })
//         .catch(error => {
//             console.error('Error fetching recent screenshots:', error);
//         });
// }

// // Add event listener to the stop button in the floating timer
// document.getElementById('floating-stop-btn').addEventListener('click', stopTimer);

// app.js or within <script> in index.html

    async function fetchRecentScreenshots() {
    try {
        // Ensure URL points to the correct local server
        const response = await fetch('https://actracker.onrender.com/api/recent-screenshots');
        if (!response.ok) throw new Error('Failed to fetch screenshots from server');

        const screenshots = await response.json();

        const screenshotsContainer = document.getElementById('recent-screenshots');
        screenshotsContainer.innerHTML = ''; // Clear any existing images

        if (screenshots.length === 0) {
            screenshotsContainer.innerHTML = '<p>No screenshots found.</p>';
            return;
        }

        screenshots.forEach(screenshot => {
            const img = document.createElement('img');
            img.src = screenshot.url;
            img.alt = `Screenshot taken at ${new Date(screenshot.timestamp).toLocaleString()}`;
            img.width = 200;  // Adjust width if needed
            img.height = 150; // Adjust height if needed
            screenshotsContainer.appendChild(img);
        });
    } catch (error) {
        console.error('Error fetching recent screenshots:', error);
        const container = document.getElementById('recent-screenshots');
        container.innerHTML = '<p>Error loading screenshots. Please try again later.</p>';
    }
}

// function fetchLastScreenshot() {
//     const userId = 'user123'; // Replace with actual user ID

//     // Make the API call to fetch the last screenshot
//     fetch(`https://actracker.onrender.com/api/last-screenshot/${userId}`)
//         .then(response => response.json())  // Parse the response as JSON
//         .then(data => {
//             // Check if we received the last screenshot time
//             if (data.lastScreenshotTime) {
//                 const lastScreenshotDate = new Date(data.lastScreenshotTime).toLocaleString(); // Format the date

//                 // Update the "Last Worked" section with the formatted date
//                 document.getElementById('last-project-worked');
//                 document.getElementById('last-worked-time').innerText = lastScreenshotDate;
//             } else {
//                 // Handle case where no screenshot is available
//                 document.getElementById('last-project-worked').innerText = 'No recent screenshot available.';
//                 document.getElementById('last-worked-time').innerText = '';
//             }
//         })
//         .catch(error => {
//             console.error('Error fetching last screenshot:', error);
//             // Handle errors by displaying an appropriate message
//             document.getElementById('last-project-worked').innerText = 'Error fetching last screenshot.';
//             document.getElementById('last-worked-time').innerText = '';
//         });
// }
// document.addEventListener('DOMContentLoaded', () => {
//     fetchLastScreenshot();  // Call the function to fetch and display the last screenshot
// });

async function fetchLastScreenshot() {
    const userId = 'user123'; // Replace with actual user ID

    try {
        const response = await fetch(`https://actracker.onrender.com/api/last-screenshot/${userId}`);
        const data = await response.json();

        if (data.lastScreenshotTime) {
            // Format the timestamp for display
            const lastScreenshotDate = new Date(data.lastScreenshotTime).toLocaleString();
            document.getElementById('last-worked-time').innerText = lastScreenshotDate;
        } else {
            document.getElementById('last-worked-time').innerText = 'No recent screenshot available.';
        }
    } catch (error) {
        console.error('Error fetching last screenshot:', error);
        document.getElementById('last-worked-time').innerText = 'Error fetching last screenshot.';
    }
}

// Call fetchLastScreenshot on page load
document.addEventListener('DOMContentLoaded', fetchLastScreenshot);
// Ensure fetchRecentScreenshots is called after the DOM loads
window.addEventListener('DOMContentLoaded', fetchRecentScreenshots);

    </script>
    <script>
// Function to make the floating timer draggable
function makeDraggable(element, dragHandle) {
    let posX = 0, posY = 0, mouseX = 0, mouseY = 0;

    dragHandle.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
        e.preventDefault();
        mouseX = e.clientX;
        mouseY = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e.preventDefault();
        posX = mouseX - e.clientX;
        posY = mouseY - e.clientY;
        mouseX = e.clientX;
        mouseY = e.clientY;
        element.style.top = (element.offsetTop - posY) + "px";
        element.style.left = (element.offsetLeft - posX) + "px";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
}
// Add event listener to the stop button in the floating timer
document.getElementById('floating-stop-btn').addEventListener('click', stopTimer);

// Make the floating timer draggable
makeDraggable(document.getElementById('floating-timer'), document.getElementById('floating-timer-header'));


// // Add event listener to the "Send Invitation" button
// document.getElementById('send-invite-button').addEventListener('click', sendInvitation);
    // Wait until the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listener to the "Send Invitation" button
        document.getElementById('send-invite-button').addEventListener('click', sendInvitation);
    });

    // Function to send email invitation
    function sendInvitation() {
        console.log('Send invite function triggered');
        const email = document.getElementById('email-input').value;

        // Basic email validation
        if (!email || !validateEmail(email)) {
            alert('Please enter a valid email address');
            return;
        }

        // Send invitation email via API
        fetch('https://actracker.onrender.com/api/send-invite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        })
        .then(response => {
            if (!response.ok) {
                // Handle response error (status not 200-299)
                return response.json().then(data => {
                    throw new Error(data.message || 'Failed to send invitation');
                });
            }
            return response.json();  // Parse response as JSON
        })
        .then(data => {
            alert(data.message);  // Show success message
        })
        .catch(error => {
            console.error('Error:', error);  // Handle any fetch errors
            alert('Error sending invitation: ' + error.message);
        });
    }

    // Function to validate email format (simple regex for basic validation)
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }

function getWeekRange() {
    const now = new Date();
    const dayOfWeek = now.getDay(); // 0 (Sunday) to 6 (Saturday)
    const startDate = new Date(now); // Clone current date
    startDate.setDate(now.getDate() - dayOfWeek); // Go to Sunday

    const endDate = new Date(startDate); // Clone start date
    endDate.setDate(startDate.getDate() + 6); // Go to Saturday

    const options = { 
        weekday: 'short', // Add weekday
        month: 'short', 
        day: 'numeric',
        year: 'numeric' // Add year
    };
    
    // Format start date
    const startFormatted = startDate.toLocaleDateString('en-US', options);
    
    // For end date, we only need to show the year if it's different from the start date
    const endOptions = { 
        weekday: 'short',
        month: 'short', 
        day: 'numeric'
    };
    if (startDate.getFullYear() !== endDate.getFullYear()) {
        endOptions.year = 'numeric';
    }
    const endFormatted = endDate.toLocaleDateString('en-US', endOptions);

    return `${startFormatted} - ${endFormatted}`;
}

function updateWeekRange() {
    const weekRangeElement = document.getElementById('week-range');
    if (weekRangeElement) {
        weekRangeElement.textContent = getWeekRange();
    }
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', updateWeekRange);

const projectData = {
    projectName: document.getElementById('projectName').value,
    clientName: document.getElementById('clientName').value,
    isBillable: document.getElementById('isBillable').checked, // Assuming this is a checkbox
    managers: document.getElementById('managers').value, // Comma-separated string
    users: document.getElementById('users').value, // Comma-separated string
    viewers: document.getElementById('viewers').value, // Comma-separated string
    budgetType: document.getElementById('budgetType').value,
    basedOn: document.getElementById('basedOn').value,
    cost: document.getElementById('cost').value,
    teamsSearch: document.getElementById('teamsSearch').value // Assuming teams are input here
};
    </script>
    <script>
let mouseEvents = 0;
let keyboardEvents = 0;
let activityInterval;
let totalTime = 0;

// Add event listeners for mouse and keyboard activity
document.addEventListener('mousemove', () => mouseEvents++);
document.addEventListener('keydown', () => keyboardEvents++);


// Activity data for the week
let weeklyActivityData = {};

// Start tracking activity every second
function startActivityTracking() {
    mouseEvents = 0;
    keyboardEvents = 0;
    activityInterval = setInterval(() => {
        // Increment total time and activity counts
        secondsElapsed++;

        // Only calculate percentages if totalTime is greater than zero
        const totalTime = weeklyActivityData[today].totalTime || 1; // Use 1 as a fallback to avoid division by zero

        // Calculate mouse and keyboard usage percentages
        const mouseUsagePercentage = totalTime > 0 ? (mouseEvents / totalTime) * 100 : 0;
        const keyboardUsagePercentage = totalTime > 0 ? (keyboardEvents / totalTime) * 100 : 0;

        // Round percentages and ensure they’re numbers
        weeklyActivityData[today] = {
            mouseEvents: mouseEvents,
            keyboardEvents: keyboardEvents,
            totalTime: totalTime,
            mouseUsagePercentage: Number(mouseUsagePercentage.toFixed(2)),
            keyboardUsagePercentage: Number(keyboardUsagePercentage.toFixed(2))
        };

        // Reset counters
        mouseEvents = 0;
        keyboardEvents = 0;
    }, 1000); // Update every second
}

// Stop activity tracking and save data
function stopActivityTracking() {
    clearInterval(activityInterval);
    updateActivityGraph(); // Update the graph with the latest data
}

// Function to save activity data to the backend
async function saveActivityData() {
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
    const activityData = weeklyActivityData[today];

    try {
        const response = await fetch('https://actracker.onrender.com/api/save-activity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: 'user123',
                projectId: document.getElementById('project-select').value,
                mouseEvents: activityData.mouseEvents,
                keyboardEvents: activityData.keyboardEvents,
                totalTime: activityData.totalTime,
                mouseUsagePercentage: activityData.mouseUsagePercentage,
                keyboardUsagePercentage: activityData.keyboardUsagePercentage
            })
        });
        if (!response.ok) {
            throw new Error('Failed to save activity data');
        }
        console.log('Activity data saved:', await response.json());
    } catch (error) {
        console.error('Error saving activity data:', error);
    }
}





// Stop tracking activity
function stopActivityTracking() {
    clearInterval(activityInterval);
    sendActivityData(); // Send the final activity data
}

// Function to calculate percentages and send activity data to the server
function sendActivityData() {
    const mouseUsagePercentage = (mouseEvents / totalTime) * 100;
    const keyboardUsagePercentage = (keyboardEvents / totalTime) * 100;

    fetch('https://actracker.onrender.com/api/save-activity', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            userId: 'user123', // Replace with actual user ID
            projectId: document.getElementById('project-select').value,
            mouseEvents: mouseEvents,
            keyboardEvents: keyboardEvents,
            totalTime: totalTime,
            mouseUsagePercentage: mouseEvents.toFixed(2),
            keyboardUsagePercentage: keyboardEvents.toFixed(2),
        }),
    })
    .then(response => response.json())
    .then(data => console.log('Activity data saved:', data))
    .catch(error => console.error('Error saving activity data:', error));

    // Reset mouse and keyboard event counts for the next interval
    mouseEvents = 0;
    keyboardEvents = 0;
}
function fetchActivityData() {
    const projectId = document.getElementById('project-select').value;
    fetch(`https://actracker.onrender.com/api/get-activity/${projectId}`)
        .then(response => response.json())
        .then(data => {
            const labels = data.map(entry => new Date(entry.date).toLocaleTimeString());
            const mouseUsage = data.map(entry => entry.mouseUsagePercentage);
            const keyboardUsage = data.map(entry => entry.keyboardUsagePercentage);

            // Create the activity chart
            const ctx = document.getElementById('activity-chart').getContext('2d');
            const activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, // Time labels for x-axis
                    datasets: [{
                        label: 'Mouse Usage (%)',
                        data: mouseUsage,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false,
                    }, {
                        label: 'Keyboard Usage (%)',
                        data: keyboardUsage,
                        borderColor: 'rgba(192, 75, 75, 1)',
                        borderWidth: 1,
                        fill: false,
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100, // Limit the y-axis to 100%
                        }
                    }
                }
            });
        })
        // .catch(error => console.error('Error fetching activity data:', error));
}

// Call this function when the page loads or when a project is selected
fetchActivityData();

// Function to update the activity graph
function updateActivityGraph() {
    const labels = Object.keys(weeklyActivityData); // Weekdays
    const mouseData = labels.map(day => {
        const dayData = weeklyActivityData[day];
        return dayData.totalTime > 0 ? ((dayData.mouseEvents / dayData.totalTime) * 100).toFixed(2) : 0;
    });
    const keyboardData = labels.map(day => {
        const dayData = weeklyActivityData[day];
        return dayData.totalTime > 0 ? ((dayData.keyboardEvents / dayData.totalTime) * 100).toFixed(2) : 0;
    });

    const ctx = document.getElementById('activity-chart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Mouse Usage (%)',
                    data: mouseData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'Keyboard Usage (%)',
                    data: keyboardData,
                    borderColor: 'rgba(192, 75, 75, 1)',
                    borderWidth: 1,
                    fill: false
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Usage Percentage (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Days of the Week'
                    }
                }
            }
        }
    });
}

// Event listeners for mouse and keyboard activity
document.addEventListener('mousemove', () => mouseEvents++);
document.addEventListener('keydown', () => keyboardEvents++);

// Event listeners for timer start and stop
document.getElementById('start-timer-btn').addEventListener('click', startTimer);
document.getElementById('floating-stop-btn').addEventListener('click', stopTimer);

function fetchWorkedTimeThisWeek() {
    const userId = 'user123'; // Replace with actual user ID

    fetch(`https://actracker.onrender.com/api/total-worked-time-this-week/${userId}`)
        .then(response => response.json())
        .then(data => {
            const totalSeconds = data.totalWorkedSeconds;
            const formattedTime = formatTime(totalSeconds); // Convert seconds to hours, minutes, and seconds

            // Update the "Worked This Week" container with the formatted time
            document.getElementById('worked-time').innerText = formattedTime;
        })
        .catch(error => {
            console.error('Error fetching worked time for this week:', error);
        });
}

// Utility function to format time in HH:MM:SS
function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    return `${hours} hrs ${minutes} mins ${seconds} secs`;
}

// Fetch the worked time when the page loads
document.addEventListener('DOMContentLoaded', () => {
    fetchRecentScreenshots();  // Existing call to fetch recent screenshots
    fetchWorkedTimeThisWeek(); // Fetch total worked time for this week
});
// Fetch activity data for the current week
function fetchActivityThisWeek() {
    const userId = 'user123'; // Replace with actual user ID

    fetch(`https://actracker.onrender.com/api/activity-this-week/${userId}`)
        .then(response => response.json())
        .then(data => {
            // Parse the activity data and prepare it for the chart
            const labels = getWeekDays(); // Get labels for the current week (Sunday to Saturday)
            const mouseUsage = new Array(7).fill(0); // Initialize with zeros for each day
            const keyboardUsage = new Array(7).fill(0);

            // Populate the mouse and keyboard usage data
            data.forEach(entry => {
                const dayIndex = new Date(entry.date).getDay(); // Get the day index (0 = Sunday, 6 = Saturday)
                mouseUsage[dayIndex] = entry.mouseUsagePercentage;  // Assign mouse usage percentage to the corresponding day
                keyboardUsage[dayIndex] = entry.keyboardUsagePercentage; // Assign keyboard usage percentage to the corresponding day
            });

            // Create the activity graph
            createActivityGraph(labels, mouseUsage, keyboardUsage);
        })
        .catch(error => {
            console.error('Error fetching activity data for this week:', error);
        });
}

// Function to get labels for the days of the current week (Sunday to Saturday)
function getWeekDays() {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const now = new Date();
    const currentDay = now.getDay();

    // Generate labels from Sunday to Saturday
    const weekDays = [];
    for (let i = 0; i < 7; i++) {
        const dayIndex = (currentDay + i) % 7; // Wrap around the week
        weekDays.push(days[dayIndex]);
    }
    return days;
}

// Function to create the activity graph using Chart.js
function createActivityGraph(labels, mouseUsage, keyboardUsage) {
    const ctx = document.getElementById('activity-chart').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels, // The days of the week
            datasets: [
                {
                    label: 'Mouse Usage (%)',
                    data: mouseUsage, // Mouse usage percentage 
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    fill: false
                },
                {
                    label: 'Keyboard Usage (%)',
                    data: keyboardUsage, // Keyboard usage percentage
                    borderColor: 'rgba(192, 75, 75, 1)',
                    borderWidth: 1,
                    fill: false
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    max: 3000, // Limit the y-axis to 100%
                    title: {
                        display: true,
                        text: 'Usage Percentage (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Days of the Week'
                    }
                }
            }
        }
    });
}

// Fetch the activity data when the page loads
document.addEventListener('DOMContentLoaded', () => {
    fetchRecentScreenshots();  // Existing call to fetch recent screenshots
    fetchWorkedTimeThisWeek(); // Fetch total worked time for this week
    fetchActivityThisWeek();   // Fetch activity data for the current week and display graph
});


       // Function to capture a screenshot via Electron
async function captureScreenshot() {
    try {
        const result = await window.electronAPI.captureScreenshot();
        if (result.success) {
            // Display the screenshot in "Recent Screenshots"
            const recentScreenshotsContainer = document.getElementById('recent-screenshots');
            const newScreenshot = document.createElement('img');
            newScreenshot.src = result.url;
            newScreenshot.alt = `Screenshot taken at ${new Date(result.timestamp).toLocaleString()}`;
            newScreenshot.style.width = '200px';
            newScreenshot.style.height = '150px';
            recentScreenshotsContainer.insertBefore(newScreenshot, recentScreenshotsContainer.firstChild);

            // Log screenshot details to console
            console.log('Screenshot captured successfully:', result.url, result.timestamp);
        } else {
            console.error('Failed to capture screenshot:', result.error);
        }
    } catch (error) {
        console.error('Error capturing screenshot:', error);
    }
}



        // Add this to your renderer JavaScript file (where your timer logic is)
let isTracking = false;

// Start button click handler
document.getElementById('start-timer-button').addEventListener('click', async () => {
    const userId = 'current-user-id'; // Replace with actual user ID
    const projectId = 'selected-project-id'; // Replace with selected project ID
    
    try {
        // Start screenshot capture
        await window.electronAPI.startScreenshotCapture({ userId, projectId });
        isTracking = true;
        
        // Start your existing timer logic here
        
        // Listen for new screenshots
        window.electronAPI.onScreenshotCaptured((event, data) => {
            if (data.success) {
                console.log('Screenshot captured:', data.url);
                // Update UI if needed
            }
        });
        
        // Listen for errors
        window.electronAPI.onScreenshotError((event, data) => {
            console.error('Screenshot error:', data.error);
            // Handle error in UI if needed
        });
    } catch (error) {
        console.error('Error starting tracking:', error);
    }
});

// Stop button click handler
document.getElementById('stop-timer-button').addEventListener('click', async () => {
    if (isTracking) {
        // Stop screenshot capture
        await window.electronAPI.stopScreenshotCapture();
        isTracking = false;
        
        // Stop your existing timer logic here
        
        // Remove screenshot listeners
        window.electronAPI.removeScreenshotListeners();
    }
});

// Handle page unload
window.addEventListener('beforeunload', () => {
    if (isTracking) {
        window.electronAPI.stopScreenshotCapture();
        window.electronAPI.removeScreenshotListeners();
    }
});

    function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const content = document.querySelector('.dashboard-content');
    
    sidebar.classList.toggle('collapsed');
    content.classList.toggle('collapsed');
    
    // Store the state in localStorage
    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

// On page load, check if sidebar was collapsed
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.querySelector('.sidebar');
    const content = document.querySelector('.dashboard-content');
    
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
        sidebar.classList.add('collapsed');
        content.classList.add('collapsed');
    }
});
function stopTracking() {
    const totalEvents = mouseEvents + keyboardEvents || 1;  // Ensure no division by zero
    const mouseUsagePercentage = (mouseEvents / totalEvents) * 100;
    const keyboardUsagePercentage = (keyboardEvents / totalEvents) * 100;

    // Send data to main process
    window.electronAPI.send('stop-tracking', {
        mouseUsagePercentage: mouseUsagePercentage.toFixed(2),
        keyboardUsagePercentage: keyboardUsagePercentage.toFixed(2),
        mouseEvents,
        keyboardEvents
    });

    // Reset counters
    mouseEvents = 0;
    keyboardEvents = 0;
};

document.addEventListener('DOMContentLoaded', () => {
    const startTimerBtn = document.getElementById('start-timer-btn');
    const stopTimerBtn = document.getElementById('floating-stop-btn');
    
    // Start button logic
    startTimerBtn.addEventListener('click', () => {
        window.electronAPI.startTrackingBrowserActivity(); // Start tracking browser activity
        startTimer(); // Existing function to start the timer
    });
    
    // Stop button logic
    stopTimerBtn.addEventListener('click', () => {
        window.electronAPI.stopTrackingBrowserActivity(); // Stop tracking browser activity
        stopTimer(); // Existing function to stop the timer
        updateBrowserActivityTable(); // Update the table with the final data
    });

    // Update Browser Activity table whenever activity data is received
    window.electronAPI.onBrowserActivityUpdated((activityData) => {
        updateBrowserActivityTable(activityData);
    });
});

// function updateBrowserActivityTable(activityData = []) {
//     const tableBody = document.getElementById('browser-activity-table-body');
//     tableBody.innerHTML = '';

//     activityData.forEach(activity => {
//         const row = document.createElement('tr');
//         row.innerHTML = `
//             <td>${activity.url}</td>
//             <td>${activity.timeSpent}%</td>
//         `;
//         tableBody.appendChild(row);
//     });
// }
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const startTimerBtn = document.getElementById('start-timer-btn');
        const stopTimerBtn = document.getElementById('floating-stop-btn');
        const userId = 'user123'; // Replace with actual user ID
        const projectId = '$projectId'; // Replace with actual project ID
        
        startTimerBtn.addEventListener('click', () => {
            window.electronAPI.startTrackingBrowserActivity();
            startTimer();
        });
        
        stopTimerBtn.addEventListener('click', () => {
            window.electronAPI.stopTrackingBrowserActivity(userId, projectId);
            stopTimer();
        });
    
        window.electronAPI.onBrowserActivityUpdated((activityData) => {
            updateBrowserActivityTable(activityData);
        });

          // Request initial data on load
         window.electronAPI.getRecentActivities();
    });
    
    function updateBrowserActivityTable(activityData = []) {
        const tableBody = document.getElementById('browser-activity-table-body');
        tableBody.innerHTML = '';
    
        activityData.forEach(activity => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${activity.title}</td>
                <td>${activity.application}</td>
                <td>${activity.timeSpentPercentage.toFixed(2)}%</td>
            `;
            tableBody.appendChild(row);
        });
    }
    </script>
    

</script>
</body>
</html>
